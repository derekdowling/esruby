#!/usr/bin/env bash

export PROXY="199.116.235.83"
export CHEF="/home/ubuntu/esruby"
export OPTS="-A -t -o User=ubuntu -i /Users/derek/.ssh/391project.pem"
export SUB_OPTS="-A -t -o User=ubuntu"
export HOME="/home/ubuntu"

# Nodes To Run Against
nodes=( 10.1.0.247 10.1.0.249 10.1.1.41 10.1.1.44 )

if [ "${1}" = "-l" ]; then
	for host in "${nodes[@]}"
	do
		echo ${host}
	done
	exit 0
fi

# See if we are proxying through our public IP, checks if $SUB_HOST is set
if [ "${1}" = "-s" ]; then
	nodes=( ${2} )
fi

for host in "${nodes[@]}"
do
	echo ${host}
	ssh $OPTS $PROXY ssh $SUB_OPTS $host <<-END
		sudo apt-get update
		sudo apt-get install build-essential curl git vim -y bison zlib1g-dev libopenssl-ruby1.9.1 libssl-dev libyaml-0-2 libxslt-dev libxml2-dev libreadline-gplv2-dev libncurses5-dev file --yes --fix-missing
		s
		sudo curl -sSL https://rvm.io/mpapis.asc | gpg --import -
		sudo curl -sSL https://get.rvm.io | bash -s stable --ruby
		sudo source /home/ubuntu/.rvm/scripts/rvm
		rm -rf $CHEF
		git clone https://github.com/derekdowling/esruby.git
		sudo gem install chef --no-rdoc --no-ri
		sudo gem install berkshelf --no-rdoc --no-ri
		sudo berks install -b $CHEF/Berksfile
		sudo hef-solo -N 391Cluster -j $CHEF/cluster.json -c $CHEF/solo.rb
		rm -rf $HOME/cs391
		git clone https://github.com/derekdowling/cs391.git
		END
done

echo "Installation Complete"

echo "Cluster Status"
curl 199.116.235.83:9200
