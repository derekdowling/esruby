#!/usr/bin/env bash

export PROXY="199.116.235.83"
export CHEF="/var/chef/cookbooks/esruby"
export OPTS="-A -t -o User=ubuntu -i /Users/derek/.ssh/391project.pem"
export SUB_OPTS="-A -t -o User=ubuntu"
export HOME="/home/user"

# Nodes To Run Against
nodes=( 10.1.0.247 10.1.0.249 10.1.1.41 10.1.1.44 )

if [ "${1}" = "-l" ]; then
	for host in "${nodes[@]}"
	do
		echo ${host}
	done
	exit 0
fi

# See if we are proxying through our public IP, checks if $SUB_HOST is set
if [ "${1}" = "-s" ]; then
	nodes=( ${2} )
fi

for host in "${nodes[@]}"
do
	echo ${host}
	ssh $OPTS $PROXY ssh $SUB_OPTS $host <<-END
		sudo apt-get update
		sudo apt-get install build-essential curl git vim -y bison zlib1g-dev libopenssl-ruby1.9.1 libssl-dev libyaml-0-2 libxslt-dev libxml2-dev libreadline-gplv2-dev libncurses5-dev file --yes --fix-missing
		command curl -sSL https://rvm.io/mpapis.asc | gpg --import -
		curl -sSL https://get.rvm.io | bash -s stable --ruby
		source /home/ubuntu/.rvm/scripts/rvm
		curl -# -L http://www.opscode.com/chef/install.sh | sudo bash -s --
		sudo mkdir -p /etc/chef
		sudo mkdir -p $CHEF
		sudo curl -# -L -k -o /tmp/esruby-master.tar.gz https://github.com/derekdowling/esruby/archive/master.tar.gz
		sudo tar --strip 1 -C $CHEF -xf /tmp/esruby-master.tar.gz
		gem install berkshelf --no-rdoc --no-ri
		berks vendor /var/chef/cookbooks/ -b $CHEF/Berksfile
		chef-solo -N 391Cluster -j $CHEF/cluster.json -c $CHEF/solo.rb
		END
done

echo "Installation Complete"

echo "Cluster Status"
curl $def_host:9200
